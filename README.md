# Платформа торговой сети электроники

## Описание проекта

Данный проект представляет собой backend-часть для платформы торговой сети электроники. Реализован с использованием Django и Django REST Framework (DRF), предоставляя API для управления иерархической структурой сети и админ-панель для управления данными.

## Основные функции

- **Иерархическая структура сети**:
  - 3 уровня: завод, розничная сеть, индивидуальный предприниматель
  - Гибкие связи между элементами сети
- **Управление элементами сети**:
  - CRUD операции для всех типов звеньев сети
  - Автоматическое определение уровня иерархии
- **Управление продуктами**:
  - Привязка продуктов к элементам сети
  - Учет даты выхода продукта на рынок
- **Административные функции**:
  - Просмотр и редактирование объектов в админ-панели
  - Очистка задолженности перед поставщиком
  - Фильтрация по городу
- **API функции**:
  - Полноценный CRUD для поставщиков
  - Фильтрация по стране
  - Контроль доступа для сотрудников

## Технологии

- Python 3.8+
- Django 3+
- Django REST Framework 3.10+
- PostgreSQL 10+
- Gunicorn
- Docker
- drf-spectacular (для API документации)
- django-filter
- Coverage (для анализа покрытия кода тестами)
- Loguru (для улучшенного логирования)

## Модели

### Модель звена сети (NetworkNode)
- `name` — название звена сети
- `node_type` — тип звена (завод, розничная сеть, ИП)
- `email` — электронная почта
- `country` — страна
- `city` — город
- `street` — улица
- `house_number` — номер дома
- `supplier` — ссылка на поставщика (ForeignKey)
- `debt_to_supplier` — задолженность перед поставщиком (Decimal)
- `created_at` — время создания (auto_now_add)
- `level` — уровень иерархии (вычисляемое поле)

### Модель продукта (Product)
- `name` — название продукта
- `model` — модель продукта
- `release_date` — дата выхода на рынок
- `network_node` — звено сети, которому принадлежит продукт (ForeignKey)

## Права доступа

- **Анонимные пользователи**: 
  - Доступ запрещен
- **Активные сотрудники**:
  - Полный доступ к API (CRUD операции), кроме удаления (удаление доступно только администратору)
- **Администраторы**:
  - Полный доступ через админ-панель + Полный доступ к API (CRUD операции)
  - Доступ к специальным действиям (очистка задолженности)

## Установка и настройка

### 1. Установка зависимостей

Убедитесь, что у вас установлен Python версии 3.8+. Для установки зависимостей:

```bash
poetry install
```

### 2. Настройка переменных окружения

Скопируйте файл `.env.example` в `.env`:

```bash
cp .env.example .env
```

Заполните файл `.env` необходимыми значениями.

```plaintext
SUPERUSER_EMAIL=admin@example.com
SUPERUSER_PASSWORD=adminpassword123
NORMAL_USER_EMAIL=user@example.com
NORMAL_USER_PASSWORD=userpassword123
REDIS_URL=redis://127.0.0.1:6379/0
```

### 3. Запуск сервера разработки

```bash
python manage.py migrate
python manage.py runserver
```


---

## Кастомные команды

### Команда `csu.py` (Create Super User)
Для автоматического создания суперпользователя и обычного пользователя выполните:

```bash
python manage.py csu
```

Эта команда создаёт двух пользователей на основе значений из `.env`:
1. Суперпользователь: `SUPERUSER_EMAIL` и `SUPERUSER_PASSWORD`.
2. Обычный пользователь: `NORMAL_USER_EMAIL` и `NORMAL_USER_PASSWORD`.

Если пользователи уже существуют, команда уведомит об этом.


### Команда `fill_db` (Fill Database)

Для заполнения базы данных тестовыми данными выполните:

```bash
python manage.py fill_db
```

Эта команда создает демонстрационную структуру сети продаж электроники, включая:

1. **Звенья сети**:
   - 1 завод (уровень 0)
   - 2 розничные сети (уровень 1)
   - 1 индивидуального предпринимателя (уровень 2)

2. **Продукты**:
   - По одному продукту для каждого звена сети (всего 4 продукта)
   - Смартфоны, ноутбуки, планшеты и телевизоры

3. **Иерархические связи**:
   - Розничные сети связаны с заводом
   - Индивидуальный предприниматель связан с розничной сетью

4. **Финансовые обязательства**:
   - Установлены суммы задолженностей между звеньями

После выполнения команда выводит в консоль информацию о каждом созданном объекте.

**Пример создаваемой структуры**:
```
Завод Электроника (уровень 0)
├── Сеть Магазинов Техно (уровень 1, долг: 100000.00)
│   └── ИП Иванов (уровень 2, долг: 25000.00)
└── ТехноМаркет (уровень 1, долг: 50000.00)
```

**Примечания**:
1. Команда предназначена для демонстрационных и тестовых целей
2. При повторном запуске создает новые объекты (может привести к дублированию данных)
3. Для очистки тестовых данных используйте команду `flush` или удалите объекты через админ-панель



### Создание и загрузка фикстур

Для создания фикстуры групп пользователей выполните:

```bash
python3 manage.py dumpdata auth.group --indent 2 > users/fixtures/groups.json
```

Эта команда создаст файл `groups.json` в директории `users/fixtures/` с данными о группах пользователей.

Для загрузки данных из созданной фикстуры в базу данных используйте команду:

```bash
python3 manage.py loaddata users/fixtures/groups.json
```

Эта команда загрузит группы пользователей из файла `groups.json` в базу данных.

---


## Запуск с использованием Docker

Убедитесь, что у вас установлены Docker и Docker Compose.

```bash
docker-compose up -d --build
```

Приложение будет доступно по адресу http://localhost:8082.

## API Документация

Документация API доступна по адресу `/swagger/` или `/redoc/` после запуска сервера.

## Админ-панель

Админ-панель доступна по адресу `/admin/`. Особенности админ-панели:

- Ссылка на поставщика для каждого объекта
- Фильтр по названию города
- Admin action для очистки задолженности
- Удобное отображение иерархии сети


## Тестирование
Текущее покрытие тестами составляет 95% кода проекта (coverage_report.txt)
Для запуска тестов вы можете использовать следующие команды:

1. Запуск всех тестов:
```bash
python3 manage.py test
```

2. Запуск тестов для конкретного приложения (например, для приложения 'network_nodes'):
```bash
python3 manage.py test network_nodes
```

3. Запуск тестов с покрытием кода:
```bash
coverage run --source='.' manage.py test
```

4. Просмотр отчета о покрытии кода:
```bash
coverage report
```

5. Запуск отдельного теста:
```bash
python3 manage.py test network_nodes.tests.NetworkNodeModelTest
```
---

## Ключевые особенности проекта

- **Усиленная система безопасности**:
  - Использование закодированных UID вместо простых ID для идентификации объектов.
  - Токен-аутентификация с переменным токеном для повышенной безопасности.
  - Шифрование паролей пользователей перед сохранением в базу данных.

- **Оптимизация для фронтенд-разработки**:
  - Вывод данных API в формате camelCase для удобства интеграции с фронтендом.

- **Гибкая архитектура API**:
  - Использование generic views Django REST Framework для поддержки частичного обновления объектов (PATCH и PUT запросы).

- **Надежная валидация данных**:
  - Двухуровневая валидация: на уровне модели (в методе clean) и на уровне API (в валидаторах).

---

## Особенности реализации

1. **Гибкая иерархия сети**:
   - Уровень иерархии вычисляется автоматически
   - Возможность создания любых связей между элементами

2. **Контроль задолженности**:
   - Запрет на обновление через API
   - Возможность очистки через админ-панель

3. **Безопасность**:
   - Доступ к API только для активных сотрудников
   - Валидация данных на нескольких уровнях

4. **Удобство администрирования**:
   - Специальные фильтры и действия в админ-панели
   - Наглядное отображение связей

## Автор

Telegram @eslobodyanik